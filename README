## Connexion à Azure
az login

# cd terraform
# terraform init
# terraform plan
# terraform apply

## Récupérer l'adresse IP affiché dans les outputs
//20.216.181.43
// TODO vérifier l'affichage de l'api

# Build and push l'image docker
az acr login --name registrywadouxmorin
cd ../flask-app
docker build -t registrywadouxmorin.azurecr.io/flask-app:latest .
docker push registrywadouxmorin.azurecr.io/flask-app:latest

## Connexion au cluster Kubernetes
az aks get-credentials --overwrite-existing -n AKSCluster -g rg-esgi-wadoux-morin

## Installer helm si besoin
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update

## Installer l'ingress controller

helm install ingress-nginx ingress-nginx/ingress-nginx \
    --namespace ingress-basic \
    --create-namespace \
    --set controller.replicaCount=2 \
    --set controller.nodeSelector."kubernetes\.io/os"=linux \
    --set controller.service.loadBalancerIP=<IP_PUBLIQUE> \
    --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-internal"=false \
    --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz

kubectl apply -n ingress-basic -f kubernetes
// TODO mettre le namespace directement dans le fichier yaml

curl IPPublic